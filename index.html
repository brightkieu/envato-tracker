<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Envato Tracker - OAuth Callback</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        max-width: 450px;
        width: 100%;
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #82b541 0%, #73a72d 100%);
        border-radius: 50%;
        margin: 0 auto 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: white;
        box-shadow: 0 8px 20px rgba(130, 181, 65, 0.3);
      }

      .title {
        font-size: 28px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 12px;
        letter-spacing: -0.5px;
      }

      .subtitle {
        color: #718096;
        margin-bottom: 30px;
        line-height: 1.6;
        font-size: 16px;
      }

      .status {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .success {
        background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
        color: #276749;
        border: 2px solid #68d391;
      }

      .error {
        background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        color: #c53030;
        border: 2px solid #f56565;
      }

      .loading {
        background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
        color: #b7791f;
        border: 2px solid #f6e05e;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .code-display {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin: 25px 0;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 13px;
        word-break: break-all;
        color: #2d3748;
        max-height: 150px;
        overflow-y: auto;
      }

      .btn {
        background: linear-gradient(135deg, #82b541 0%, #73a72d 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(130, 181, 65, 0.4);
        margin: 10px 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(130, 181, 65, 0.5);
      }

      .btn:active {
        transform: translateY(0);
      }

      .debug-info {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-top: 25px;
        text-align: left;
        font-size: 11px;
        color: #718096;
        max-height: 200px;
        overflow-y: auto;
      }

      .countdown {
        font-size: 14px;
        color: #718096;
        margin-top: 15px;
      }

      .redirect-info {
        background: #ebf8ff;
        border: 2px solid #90cdf4;
        border-radius: 12px;
        padding: 15px;
        margin: 20px 0;
        color: #2b6cb0;
        font-size: 14px;
        line-height: 1.5;
      }

      .manual-options {
        margin-top: 20px;
      }

      .deep-link-display {
        background: #edf2f7;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        padding: 10px;
        margin: 15px 0;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        word-break: break-all;
        color: #4a5568;
      }

      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
          margin: 10px;
        }

        .title {
          font-size: 24px;
        }

        .btn {
          width: 100%;
          margin: 5px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">üéØ</div>
      <h1 class="title">Envato Tracker</h1>
      <p class="subtitle">ƒêang x·ª≠ l√Ω k·∫øt n·ªëi v·ªõi t√†i kho·∫£n Envato c·ªßa b·∫°n...</p>

      <div id="status" class="status loading">
        <div class="spinner"></div>
        ƒêang x·ª≠ l√Ω OAuth callback...
      </div>

      <div id="redirect-info" class="redirect-info" style="display: none">
        <strong>üöÄ ƒêang chuy·ªÉn v·ªÅ ·ª©ng d·ª•ng...</strong><br />
        N·∫øu ·ª©ng d·ª•ng kh√¥ng t·ª± ƒë·ªông m·ªü, vui l√≤ng b·∫•m n√∫t b√™n d∆∞·ªõi.
      </div>

      <div id="code-display" class="code-display" style="display: none"></div>

      <div id="countdown" class="countdown" style="display: none">
        T·ª± ƒë·ªông chuy·ªÉn v·ªÅ app trong <span id="timer">3</span> gi√¢y...
      </div>

      <div id="manual-options" class="manual-options" style="display: none">
        <a href="#" id="manual-deep-link" class="btn">üì± M·ªü Envato Tracker</a>
        <div id="deep-link-display" class="deep-link-display"></div>
      </div>

      <div id="debug-info" class="debug-info" style="display: none"></div>
    </div>

    <script>
      // Utility functions
      const $ = id => document.getElementById(id);
      const show = id => ($(id).style.display = 'block');
      const hide = id => ($(id).style.display = 'none');

      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');
      const state = urlParams.get('state');
      const errorDescription = urlParams.get('error_description');

      // Elements
      const statusEl = $('status');
      const codeDisplayEl = $('code-display');
      const debugInfoEl = $('debug-info');
      const countdownEl = $('countdown');
      const timerEl = $('timer');
      const manualOptionsEl = $('manual-options');
      const manualDeepLinkEl = $('manual-deep-link');
      const deepLinkDisplayEl = $('deep-link-display');
      const redirectInfoEl = $('redirect-info');

      // Debug info
      const debugInfo = {
        timestamp: new Date().toISOString(),
        url: window.location.href,
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        code: code ? code.substring(0, 20) + '...' : null,
        error: error,
        errorDescription: errorDescription,
        state: state,
        allParams: Object.fromEntries(urlParams),
        pageLoadTime: new Date().toISOString(),
      };

      // Show debug info in development or with debug param
      if (
        window.location.hostname === 'localhost' ||
        window.location.hostname === '127.0.0.1' ||
        window.location.search.includes('debug=1')
      ) {
        debugInfoEl.innerHTML = `
              <strong>üîç Debug Information:</strong><br>
              <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
          `;
        show('debug-info');
      }

      // Enhanced logging
      console.log('üéØ [CALLBACK] OAuth Callback Page Loaded');
      console.log('üéØ [CALLBACK] Debug Info:', debugInfo);

      // Main processing logic
      if (error) {
        handleOAuthError(error, errorDescription);
      } else if (code) {
        handleOAuthSuccess(code, state);
      } else {
        handleInvalidResponse();
      }

      function handleOAuthError(error, description) {
        console.error('‚ùå [CALLBACK] OAuth Error:', error, description);

        statusEl.className = 'status error';
        statusEl.innerHTML = `
              ‚ùå L·ªói OAuth: ${error}<br>
              <small>${
                description || 'Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£'
              }</small>
          `;

        // Show manual options immediately for errors
        setTimeout(() => {
          redirectToApp('error', {error, description});
        }, 2000);
      }

      function handleOAuthSuccess(code, state) {
        console.log(
          '‚úÖ [CALLBACK] OAuth Success with code:',
          code.substring(0, 10) + '...',
        );

        statusEl.className = 'status success';
        statusEl.innerHTML = `
              ‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!<br>
              <small>ƒêang chuy·ªÉn v·ªÅ ·ª©ng d·ª•ng...</small>
          `;

        show('redirect-info');

        // Show code for debugging
        codeDisplayEl.innerHTML = `
              <strong>üîë Authorization Code:</strong><br>
              <code>${code}</code>
              ${
                state
                  ? `<br><br><strong>üîí State:</strong><br><code>${state}</code>`
                  : ''
              }
          `;
        show('code-display');

        // Start countdown
        startCountdown(() => {
          redirectToApp('success', {code, state});
        });
      }

      function handleInvalidResponse() {
        console.warn('‚ö†Ô∏è [CALLBACK] Invalid OAuth Response');

        statusEl.className = 'status error';
        statusEl.innerHTML = `
              ‚ùå Ph·∫£n h·ªìi OAuth kh√¥ng h·ª£p l·ªá<br>
              <small>Kh√¥ng nh·∫≠n ƒë∆∞·ª£c authorization code ho·∫∑c error</small>
          `;

        setTimeout(() => {
          redirectToApp('error', {error: 'Invalid OAuth response'});
        }, 2000);
      }

      function startCountdown(callback) {
        let seconds = 3;
        timerEl.textContent = seconds;
        show('countdown');

        const countdown = setInterval(() => {
          seconds--;
          timerEl.textContent = seconds;

          if (seconds <= 0) {
            clearInterval(countdown);
            hide('countdown');
            callback();
          }
        }, 1000);
      }

      function redirectToApp(type, data) {
        // Use envatotracker://callback for CallbackScreen
        const deepLinkUrl = `envatotracker://dashboard?code=${data.code.toString()}`;

        console.log(
          'üöÄ [CALLBACK] Redirecting to CallbackScreen:',
          deepLinkUrl,
        );
        console.log(
          'üöÄ [CALLBACK] Params being sent:',
          Object.fromEntries(params),
        );

        // Show the deep link for manual use
        deepLinkDisplayEl.innerHTML = `
              <strong>Deep Link URL:</strong><br>
              ${deepLinkUrl}
          `;

        manualDeepLinkEl.href = deepLinkUrl;
        show('manual-options');

        // Try to open the app automatically
        try {
          window.location.href = deepLinkUrl;
          console.log('‚úÖ [CALLBACK] Deep link triggered successfully');
        } catch (error) {
          console.error('‚ùå [CALLBACK] Failed to trigger deep link:', error);
        }

        // Update status after attempt
        setTimeout(() => {
          statusEl.innerHTML = `
                  üì± ${
                    type === 'success' ? 'K·∫øt n·ªëi th√†nh c√¥ng!' : 'C√≥ l·ªói x·∫£y ra'
                  }<br>
                  <small>N·∫øu ·ª©ng d·ª•ng kh√¥ng t·ª± ƒë·ªông m·ªü, vui l√≤ng b·∫•m n√∫t "M·ªü Envato Tracker" b√™n d∆∞·ªõi</small>
              `;
        }, 1500);
      }

      // Handle page visibility change (when user returns from app)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          console.log(
            'üëÄ [CALLBACK] Page became visible again - user returned from app',
          );
        }
      });

      // Prevent accidental navigation away during processing
      window.addEventListener('beforeunload', e => {
        if (statusEl.className.includes('loading')) {
          e.preventDefault();
          e.returnValue =
            'OAuth ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi kh·ªèi trang?';
        }
      });

      // Auto-timeout for loading state
      setTimeout(() => {
        if (statusEl.className.includes('loading')) {
          console.warn('‚è∞ [CALLBACK] Processing timeout');
          handleInvalidResponse();
        }
      }, 10000);

      console.log('üéØ [CALLBACK] OAuth Callback Handler Ready');
    </script>
  </body>
</html>
