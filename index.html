<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envato Tracker - Xác thực</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .btn {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            margin: 10px;
            cursor: pointer;
            border: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ET</div>
        <h1>Envato Tracker</h1>
        <div id="message">
            <div class="loading"></div>
            <p>Đang xử lý...</p>
        </div>
        <div id="debug"></div>
    </div>

    <script>
        // Debug function
        function addDebugInfo(info) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += '<div class="debug">' + info + '</div>';
        }

        // Lấy parameters từ URL
        const currentUrl = window.location.href;
        addDebugInfo('Current URL: ' + currentUrl);
        
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        const token = urlParams.get('token');
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        
        addDebugInfo('Parameters: type=' + type + ', token=' + (token ? 'YES' : 'NO') + ', code=' + (code ? 'YES' : 'NO') + ', error=' + error);
        
        const messageDiv = document.getElementById('message');
        
        function showMessage(isSuccess, title, description, showButtons = true) {
            const statusClass = isSuccess ? 'success' : 'error';
            const emoji = isSuccess ? '✅' : '❌';
            
            let html = `
                <p class="${statusClass}">${emoji} ${title}</p>
                <p>${description}</p>
            `;
            
            if (showButtons) {
                html += `
                    <button class="btn" onclick="openApp()">Mở ứng dụng</button>
                    <button class="btn" onclick="testDeepLink()">Test Deep Link</button>
                `;
            }
            
            messageDiv.innerHTML = html;
        }
        
        function openApp() {
            let deepLink = 'com.envatotracker://envato/callback';
            
            if (code) {
                deepLink += '?code=' + encodeURIComponent(code);
            } else if (error) {
                deepLink += '?error=' + encodeURIComponent(error);
            } else if (type && token) {
                deepLink = 'com.envatotracker://auth/confirm?type=' + type + '&token=' + encodeURIComponent(token);
            }
            
            addDebugInfo('Opening deep link: ' + deepLink);
            
            console.log('Opening deep link:', deepLink);
            
            // Thử mở deep link
            window.location.href = deepLink;
            
            // Fallback message sau 3 giây
            setTimeout(() => {
                addDebugInfo('Deep link timeout - app may not be installed');
            }, 3000);
        }
        
        function testDeepLink() {
            const testLink = 'com.envatotracker://envato/callback?code=test123';
            addDebugInfo('Testing with: ' + testLink);
            window.location.href = testLink;
        }
        
        // Xử lý các trường hợp khác nhau
        setTimeout(() => {
            if (type === 'signup' && token) {
                showMessage(true, 'Email đã được xác thực!', 'Tài khoản của bạn đã được kích hoạt thành công.');
                openApp();
            } else if (type === 'recovery' && token) {
                showMessage(true, 'Link đặt lại mật khẩu hợp lệ!', 'Bạn có thể đặt mật khẩu mới trong ứng dụng.');
                openApp();
            } else if (code) {
                showMessage(true, 'Kết nối Envato thành công!', 'Tài khoản Envato đã được cấp quyền thành công.');
                openApp();
            } else if (error) {
                let errorMessage = 'Có lỗi xảy ra trong quá trình kết nối.';
                
                if (error === 'access_denied') {
                    errorMessage = 'Bạn đã từ chối cấp quyền truy cập.';
                } else if (error === 'invalid_request') {
                    errorMessage = 'Yêu cầu không hợp lệ.';
                }
                
                showMessage(false, 'Kết nối Envato thất bại!', errorMessage);
                openApp();
            } else {
                showMessage(false, 'Link không hợp lệ', 'Không tìm thấy thông tin xác thực hợp lệ.');
            }
        }, 1000);
    </script>
</body>
</html>